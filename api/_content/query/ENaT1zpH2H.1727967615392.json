{"_path":"/database/ef-query","_dir":"database","_draft":false,"_partial":false,"_locale":"","title":"大批量Create處理時間議題與Query追蹤議題","description":"","body":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"大批量create處理時間議題與query追蹤議題"},"children":[{"type":"text","value":"大批量Create處理時間議題與Query追蹤議題"}]},{"type":"element","tag":"h2","props":{"id":"一大批量create處理時間議題"},"children":[{"type":"text","value":"一、大批量Create處理時間議題"}]},{"type":"element","tag":"h3","props":{"id":"a情境"},"children":[{"type":"text","value":"a.情境"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"近期在使用EF新增資料時遇到一次要插入大量資料時的需求(一次約快1w5千筆)。因為EF Bulk Insert要錢(第三方套件)，顧很單純使用DbContext Add，插入時間要將近30秒。"}]},{"type":"element","tag":"h3","props":{"id":"root-casue"},"children":[{"type":"element","tag":"a","props":{"href":"https://docs.microsoft.com/zh-tw/ef/ef6/saving/change-tracking/auto-detect-changes","rel":["nofollow"]},"children":[{"type":"text","value":"Root Casue"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"EF POCO在做異動時，會呼叫DetectChanges()比對所有entry集合中每一個Property的新就值，顧會造成在大量操作時拉長時間。以下為會呼叫DetectChanges()的方法"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"DbSet.Find"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"DbSet.Local"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"DbSet.Add"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"DbSet.AddRange"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"DbSet.Remove"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"DbSet.RemoveRange"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"DbSet.Attach"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"DbContext.SaveChanges"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"DbCoNtext.GetValidationErrors"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"DbContext.Entry"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"DbChangeTracker.Entries"}]}]},{"type":"element","tag":"h3","props":{"id":"b解法"},"children":[{"type":"text","value":"b.解法"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"根據上述原因，若要縮短大量資料建立時間有兩種方法"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"使用AddRange\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"直接使用AddRange一次性加入所有資料，會比起每次Add都要呼叫一次DetectChanges()時間來的短。"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Configuration.AutoDetectChangesEnabled屬性設置成false\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"直接將AutoDetectChangesEnabled設成false，Add完後再設為true。"}]}]}]}]},{"type":"element","tag":"h3","props":{"id":"c測試結果"},"children":[{"type":"text","value":"c.測試結果"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"實測結果如下，12544筆資料存取時間"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Add : 34s"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"AddRange : 13s"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"AutoDetectChangesEnabled fasle : 13s"}]}]},{"type":"element","tag":"h2","props":{"id":"二query追蹤議題"},"children":[{"type":"text","value":"二、"},{"type":"element","tag":"a","props":{"href":"https://docs.microsoft.com/zh-tw/ef/core/querying/tracking#tracking-queries","rel":["nofollow"]},"children":[{"type":"text","value":"Query追蹤議題"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"For處理大批量Create處理時間議題也稍微查一下Query部分，發現EF查詢預設有Tracking的設計。稍微寫一下Testing Code如下"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Testing Code","src":"/blog/images/03/02/001.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"操作步驟為"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Step1: Context1 索取Mario資料"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Step2: Context2 新增一筆Test資料"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Step3: Context1 修改Mario資料為Jack"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"結果如下"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Result","src":"/blog/images/03/02/002.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"可以發現Context1查覺到筆數有增加，但Context2獨到的Name能然為舊值。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"因為Context2拿取了Cache資料內容，第二次Query並沒從DB讀取。所以讀到的值仍為舊值。此時如果我們將Context2第二查詢改為"}]},{"type":"element","tag":"pre","props":{"className":"language-= github-light_github-dark","code":"dbContext2.TestRecord.AsNoTracking().SingleOrDefault(x => x.Id == 1).Name\n","language":"=","meta":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"dbContext2.TestRecord.AsNoTracking().SingleOrDefault(x => x.Id == 1).Name"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"此時讀到的值則就會是Context1改過的Name值Jack，因此如果在唯讀的使用情境下，使用不追蹤查詢可以加快查詢速度。(待實測)"}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":".github-light_github-dark{color:#24292e;background:#fff;}.dark .github-light_github-dark{color:#e1e4e8;background:#24292e;}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"一大批量create處理時間議題","depth":2,"text":"一、大批量Create處理時間議題","children":[{"id":"a情境","depth":3,"text":"a.情境"},{"id":"root-casue","depth":3,"text":"Root Casue"},{"id":"b解法","depth":3,"text":"b.解法"},{"id":"c測試結果","depth":3,"text":"c.測試結果"}]},{"id":"二query追蹤議題","depth":2,"text":"二、Query追蹤議題"}]}},"_type":"markdown","_id":"content:4.database:2.EF Query追蹤議題.md","_source":"content","_file":"4.database/2.EF Query追蹤議題.md","_extension":"md"}