# Api Key Credential Management

## 情境
實務上串接時需串別的部門Notify服務，但中間要過Gateway，需要跟Gatway所屬部門申請認證Key，但這Key是人工核發的，稍微思考一下Best Practice是什麼。

## 疏離

### 角色轉換思考
我有一個Gateway服務系統，會去串不同部門的服務。其他系統經過我們Gateway服務系統時需要帶我們給的API certifaied Key做認證識別。目前我們這個API certifaied Key是人工核發. 我覺得設計不太好。因為Key期限要到的時候還要人工去處理。


### 設計合理性
針對情境去做最適應思考設計，所以沒有一個絕對答案。我覺得最方便的做法是OAuth 2.0 的 Client Credentials Grant Flow 認證。但實作OAuth 2.0 設計會牽扯很多工作項目，如果是API Key認證，相對起來設計比較簡單沒錯。

先來考慮Context情境目前看來設計上會有些考量

1. 公司大多會是內網環境，如果只是內網環境。人工替換Key目前問起來也算常見。但對於ITIL 或是ISO 20000在IT治理管理上會是優化項目。

2. 如果系統對外，最好方法當然是照OAuth Flow設計。如果還是想堅持使用API Key，除了防火牆，在金鑰演算法部分應該都是需要被審核設計。

### [Google 的 API 金鑰管理最佳實踐](https://cloud.google.com/docs/authentication/api-keys)

1. 限制 API 金鑰的使用範圍：
    - API 限制：將金鑰限制為只能存取特定的 API，避免未經授權的使用。
    - 應用程式限制 : 限制哪些應用程式或 IP 位址可以使用該金鑰，確保只有授權的系統能夠存取。

2. 定期輪替和撤銷金鑰
    - 定期更新：定期更新 API 金鑰，減少因金鑰洩漏而帶來的風險。
    - 即時撤銷 : 當發現金鑰可能被濫用時，應立即撤銷並重新發佈新的金鑰。

3. 監控和配額管理
    - 監控使用情況 : 監控追蹤 API 金鑰的使用情況，及時發現異常活動。
    - 設定配額限制 : 為 API 設定使用配額，防止濫用並控制成本。

4. 使用更安全的認證方式
    - OAuth 2.0 : 對於需要更高安全性的應用，建議使用 OAuth 2.0 等更安全的認證方式，提供細緻的存取控制。

透過遵循上述最佳實踐，可以有效地管理 API 金鑰，確保系統的安全性和穩定性。

###  API Key 自動化更新

1. 輪替機制（Key Rotation）
    - 使用腳本或服務，定期生成新金鑰並將其更新到需要使用的系統。
    - 確保新金鑰啟用前，舊金鑰依然有效一段時間，避免中斷服務。
    - 設置一個自動更新週期（例如每 30 天）。

2. Endpoint 配合更新
    - 提供一個安全的 API Endpoint，例如 /refresh-api-key。
    - 使用該 Endpoint 提供 
        - 新的 API Key：返回新的有效金鑰。
        - 舊金鑰的失效時間：明確舊金鑰將何時失效，給客戶端留足緩衝時間。

3. 雙金鑰模式（Dual-Key Approach）
    - 無縫切換 : 允許新舊金鑰同時有效一段時間，確保應用程式有時間切換到新金鑰。
    - 應用檢測 : *客戶端可定期檢查是否需要切換到新金鑰。

4. 結合安全傳輸與存儲 
    - TLS 保護：確保 API Key 傳輸時的安全性。
    - 密文存儲：在伺服器和客戶端，對 API Key 進行加密存儲。

### 是否實作自動化更新?

推薦理由:
- 業務規模大，需要頻繁發佈和管理 API Key，人工管理成本高。
- 技術基礎強，有能力實作並維護一個穩定、安全的金鑰管理系統。

不推理由:
- 系統簡單，如只有少量用戶，人工管理可能更直觀。
- 資源不足，無法提供足夠的開發和安全測試資源。

### 改善計畫設想

短期 : 建立標準化的申請表單和流程，實作基本的金鑰管理系統與建立即時監控機制
中期 : 開發自助服務平台， 實作自動化的審核流程與建立金鑰輪換機制
長期 : 建立完整的金鑰生命週期管理，實作分層式金鑰架構與整合公司的身分識別系統

#### 金鑰生命週期管理參考

![KM-lifecycle-cropped](images/100/apikeycredential/KM-lifecycle-cropped.jpg)

- Creation（創建）: 金鑰的生成階段，系統會依據特定的加密演算法和資安需求來產生新的加密金鑰。

- Backup (備份) : 為了資安措施，金鑰匙產生後須立即進行備份，一般會放在硬體安全模組（HSM）中，雲端會放到類似雲端金鑰管理服務（如 AWS KMS、Google Cloud KMS）。

- Deployment（佈署）: 這個階段是將金鑰實際部署到運作環境中。金鑰會被安全地散佈給需要使用的系統或使用者。

- Monitoring (監控) : 當金鑰開始使用後，需要持續進行監控。系統會追蹤金鑰的使用狀況，檢查是否有異常存取模式或潛在的資安威脅。

- Rotation (更換) : 為了維持資安，金鑰需要定期更換。這就像定期更新 SSL 憑證一樣，可以降低金鑰被破解的風險。

- Expiration (過期) : 每個金鑰都有其設定的有效期限。當金鑰達到期限時，系統會將其標記為過期。這類似於 SSL 憑證的到期日，提醒管理員進行更新。

- Archival (封存) : 過期的金鑰不會立即被刪除，而是先進行封存。這些金鑰可能還需要用來解密歷史資料。就像我們會保存舊系統的存取金鑰，以備日後需要查看歷史資料。

- Destruction (銷毀) : 這是金鑰生命週期的最終階段。當確定金鑰真的不再需要時，會以安全的方式將其永久刪除。這個過程必須徹底，確保金鑰無法被還原，就像是要確實清除硬碟中的敏感資料。

#### 金鑰生命週期管理參考

分層式金鑰架構是一種多層次的金鑰管理策略，目的是簡化金鑰管理並增強系統的安全性。該架構通常包含以下層次：

- 根金鑰（Root Key）
    -  